<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å•è¯æœ¬ - äº‘åŒæ­¥</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f6f6f6;
    }
    .card {
      background: white;
      margin: 0.5em 0;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    button {
      padding: 0.4em 1em;
      margin: 0.3em;
      font-size: 14px;
    }
    #login-area {
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 1em;
    }
    #login-status {
      margin: 0;
    }
    #wordbook-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5em;
  align-items: center;
}
  </style>
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, getDocs, deleteDoc, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCpvG54UwNFw--aZxCOu1VBKNX-saQsgl0",
      authDomain: "mywordapp-411d4.firebaseapp.com",
      projectId: "mywordapp-411d4",
      storageBucket: "mywordapp-411d4.firebasestorage.app",
      messagingSenderId: "189418628590",
      appId: "1:189418628590:web:80a13a63e35302db5fdaff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    let userId = null;
    let currentBookId = null;
    let allWords = [];
    let currentPage = 1;
    let perPage = 10;

    onAuthStateChanged(auth, async (user) => {
      const status = document.getElementById("login-status");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (user) {
        userId = user.uid;
        status.innerText = `âœ… å·²ç™»å½•ï¼š${user.displayName || user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        await loadWordbooks();
      } else {
        userId = null;
        status.innerText = "âŒ æœªç™»å½•";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        document.getElementById("wordbook-list").innerHTML = "";
        document.getElementById("active-book").innerText = "ğŸ“˜ å½“å‰å•è¯æœ¬ï¼š";
        document.getElementById("word-list").innerHTML = "";
      }
    });

    document.getElementById("loginBtn").onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("ç™»å½•å¤±è´¥ï¼š" + err.message);
      }
    };

    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth);
    };

    async function loadWordbooks() {
  const snap = await getDocs(collection(db, "users", userId, "wordbooks"));
  const list = document.getElementById("wordbook-list");
  const createBtn = document.getElementById("createBookBtn");

  list.innerHTML = ""; // æ¸…ç©ºåŸå†…å®¹

  snap.forEach(docSnap => {
    // ç›´æ¥åˆ›å»ºæŒ‰é’®ï¼Œä¸è¦ç”¨divåŒ…è£¹
    const btn = document.createElement("button");
    btn.innerText = `ğŸ“˜ ${docSnap.data().name}`;
    btn.onclick = () => loadWords(docSnap.id, docSnap.data().name);
    list.appendChild(btn);
  });

  list.appendChild(createBtn); // å§‹ç»ˆæ”¾åœ¨æœ€å
}


    document.getElementById("createBookBtn").onclick = async () => {
      const name = prompt("è¯·è¾“å…¥å•è¯æœ¬åç§°ï¼š");
      if (!name) return;
      await addDoc(collection(db, "users", userId, "wordbooks"), { name });
      loadWordbooks();
    };

    function loadWords(bookId, name) {
      currentBookId = bookId;
      document.getElementById("active-book").innerText = `ğŸ“˜ å½“å‰å•è¯æœ¬ï¼š${name}`;
      const list = document.getElementById("word-list");
      list.innerHTML = "åŠ è½½ä¸­...";
      const q = query(
        collection(db, "users", userId, "wordbooks", bookId, "words"),
        orderBy("createdAt", "desc")
      );
      onSnapshot(q, snap => {
        allWords = [];
        snap.forEach(docSnap => {
          const w = docSnap.data();
          allWords.push({ docSnap, w });
        });
        currentPage = 1;
        renderPagedWords();
      });
    }

    document.getElementById("addBtn").onclick = async () => {
      const word = document.getElementById("word").value.trim();
      const meaning = document.getElementById("meaning").value.trim();
      if (!word || !meaning || !currentBookId) return alert("è¯·å¡«å†™å®Œæ•´ï¼Œå¹¶é€‰æ‹©å•è¯æœ¬");

      let phonetic = '';
      let audio = '';

      try {
        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
        if (!res.ok) throw new Error("è¯å…¸æŸ¥è¯¢å¤±è´¥");
        const data = await res.json();
        phonetic = data[0].phonetic || (data[0].phonetics[0] || {}).text || '';
        audio = (data[0].phonetics.find(p => p.audio) || {}).audio || '';
        if (!phonetic && !audio) {
          alert("âš ï¸ è·å–ä¸åˆ°éŸ³æ ‡å’Œå‘éŸ³ï¼Œä»å°†ä¿å­˜å•è¯");
        }
      } catch (err) {
        alert("âš ï¸ æŸ¥è¯¢è¯å…¸å¤±è´¥ï¼Œå¯èƒ½æ‹¼å†™é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜ï¼Œä»å°†ä¿å­˜å•è¯");
      }

      await addDoc(collection(db, "users", userId, "wordbooks", currentBookId, "words"), {
        text: word,
        meaning,
        phonetic,
        audio: audio.startsWith('//') ? 'https:' + audio : audio,
        createdAt: new Date()
      });

      document.getElementById("word").value = "";
      document.getElementById("meaning").value = "";
    };

    window.deleteWord = async function(id) {
      await deleteDoc(doc(db, "users", userId, "wordbooks", currentBookId, "words", id));
    };

    window.updatePerPage = function () {
      perPage = parseInt(document.getElementById("perPageSelect").value);
      currentPage = 1;
      renderPagedWords();
    };

    window.prevPage = function () {
      if (currentPage > 1) {
        currentPage--;
        renderPagedWords();
      }
    };

    window.nextPage = function () {
      const totalPages = Math.ceil(allWords.length / perPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderPagedWords();
      }
    };

    function renderPagedWords() {
      const list = document.getElementById("word-list");
      list.innerHTML = "";
      const start = (currentPage - 1) * perPage;
      const pageWords = allWords.slice(start, start + perPage);
      pageWords.forEach(({ docSnap, w }) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
      <div style='display:flex;align-items:center;gap:0.5em;justify-content:space-between;'>
        <div style="display:flex;align-items:center;gap:0.5em;">
          <b>${w.text}</b>
          <span style="color:gray;font-weight:normal;">${w.phonetic || ''}</span>
          <button onclick="document.getElementById('a-${docSnap.id}').play()">ğŸ”Š</button>
          <audio id="a-${docSnap.id}" src="${w.audio}"></audio>
        </div>
        <button onclick="deleteWord('${docSnap.id}')">åˆ é™¤</button>
      </div>
      <div>${w.meaning}</div>
    `;
        list.appendChild(div);
      });
      const totalPages = Math.ceil(allWords.length / perPage);
      document.getElementById("page-info").innerText = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
      document.getElementById("pagination-controls").style.display = allWords.length > perPage ? "block" : "none";
    }
    window.loadWords = loadWords;
  </script>
</head>
<body>
  <h2>ğŸ§  æˆ‘çš„å•è¯æœ¬</h2>
  <div id="login-area">
    <p id="login-status">ç™»å½•æ£€æµ‹ä¸­...</p>
    <button id="loginBtn">ä½¿ç”¨ Google ç™»å½•</button>
    <button id="logoutBtn" style="display:none">ç™»å‡º</button>
  </div>
  <div>
  <h3>ğŸ“ æˆ‘çš„å•è¯æœ¬</h3>
  <div id="wordbook-list">
    <!-- å•è¯æœ¬æŒ‰é’®å’Œåˆ›å»ºæŒ‰é’®éƒ½åœ¨è¿™é‡Œ -->
    <button id="createBookBtn">â• åˆ›å»ºæ–°å•è¯æœ¬</button>
  </div>
</div>
  <hr>
  <h3 id="active-book">ğŸ“˜ å½“å‰å•è¯æœ¬ï¼š</h3>
  <input id="word" placeholder="è‹±æ–‡å•è¯">
  <input id="meaning" placeholder="ä¸­æ–‡é‡Šä¹‰">
  <button id="addBtn">æ·»åŠ å•è¯</button>

  <!-- åˆ†é¡µæ§åˆ¶ -->
  <div id="pagination-controls" style="display: none; margin-top: 1.5em;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1em;">
      <div>
        <button onclick="prevPage()">â¬…ï¸ ä¸Šä¸€é¡µ</button>
        <span id="page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
        <button onclick="nextPage()">ä¸‹ä¸€é¡µ â¡ï¸</button>
      </div>
      <div>
        æ¯é¡µæ˜¾ç¤ºï¼š
        <select id="perPageSelect" onchange="updatePerPage()">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </div>
    </div>
  </div>

  <div id="word-list"></div>
</body>
</html>
