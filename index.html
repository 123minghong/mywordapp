<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‘åŒæ­¥å•è¯æœ¬</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyCpvG54UwNFw--aZxCOu1VBKNX-saQsgl0",
      authDomain: "mywordapp-411d4.firebaseapp.com",
      projectId: "mywordapp-411d4",
      storageBucket: "mywordapp-411d4.firebasestorage.app",
      messagingSenderId: "189418628590",
      appId: "1:189418628590:web:80a13a63e35302db5fdaff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let userId = null;
    let currentBookId = null;

    // åŒ¿åç™»å½•
    signInAnonymously(auth)
      .catch(err => alert("ç™»å½•å¤±è´¥ï¼š" + err.message));

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        document.getElementById("login-status").innerText = `ç”¨æˆ·å·²ç™»å½• (ID: ${userId.slice(0,6)}...)`;
        loadWordbooks();
      }
    });

    // åŠ è½½å•è¯æœ¬åˆ—è¡¨
    async function loadWordbooks() {
      const q = query(collection(db, "users", userId, "wordbooks"));
      const snap = await getDocs(q);
      const list = document.getElementById("wordbook-list");
      list.innerHTML = "";
      snap.forEach(docSnap => {
        const div = document.createElement("div");
        div.innerHTML = `<button onclick="loadWords('${docSnap.id}', '${docSnap.data().name}')">ğŸ“˜ ${docSnap.data().name}</button>`;
        list.appendChild(div);
      });
    }

    // åˆ›å»ºæ–°å•è¯æœ¬
    document.getElementById("createBookBtn").onclick = async () => {
      const name = prompt("è¯·è¾“å…¥å•è¯æœ¬åç§°ï¼š");
      if (!name) return;
      await addDoc(collection(db, "users", userId, "wordbooks"), { name });
      loadWordbooks();
    }

    // åŠ è½½å•è¯åˆ—è¡¨
    function loadWords(bookId, name) {
      currentBookId = bookId;
      document.getElementById("active-book").innerText = `ğŸ“˜ å½“å‰å•è¯æœ¬ï¼š${name}`;
      const list = document.getElementById("word-list");
      list.innerHTML = "åŠ è½½ä¸­...";
      const q = collection(db, "users", userId, "wordbooks", bookId, "words");
      onSnapshot(q, snap => {
        list.innerHTML = "";
        snap.forEach(docSnap => {
          const w = docSnap.data();
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div style='display:flex;justify-content:space-between;'>
              <b>${w.text}</b>
              <button onclick="document.getElementById('a-${docSnap.id}').play()">ğŸ”Š</button>
              <audio id="a-${docSnap.id}" src="${w.audio}"></audio>
            </div>
            <div style='color:gray;'>${w.phonetic || ''}</div>
            <div>é‡Šä¹‰ï¼š${w.meaning}</div>
            <button onclick="deleteWord('${docSnap.id}')">åˆ é™¤</button>
          `;
          list.appendChild(div);
        });
      });
    }

    // æ·»åŠ å•è¯
    document.getElementById("addBtn").onclick = async () => {
      const word = document.getElementById("word").value.trim();
      const meaning = document.getElementById("meaning").value.trim();
      if (!word || !meaning || !currentBookId) return alert("è¯·å¡«å†™å®Œæ•´ï¼Œå¹¶å…ˆé€‰æ‹©ä¸€ä¸ªå•è¯æœ¬");
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
      const data = await res.json();
      const phonetic = data[0].phonetic || (data[0].phonetics[0] || {}).text || '';
      const audio = (data[0].phonetics.find(p => p.audio) || {}).audio || "";
      await addDoc(collection(db, "users", userId, "wordbooks", currentBookId, "words"), {
        text: word,
        meaning,
        phonetic,
        audio: audio.startsWith('//') ? 'https:' + audio : audio
      });
      document.getElementById("word").value = "";
      document.getElementById("meaning").value = "";
    }

    // åˆ é™¤å•è¯
    window.deleteWord = async function(id) {
      await deleteDoc(doc(db, "users", userId, "wordbooks", currentBookId, "words", id));
    }

    window.loadWords = loadWords;
  </script>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f6f6f6; }
    .card {
      background: white; margin: 0.5em 0; padding: 1em; border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    button { padding: 0.4em 1em; margin: 0.3em; font-size: 14px; }
  </style>
</head>
<body>
  <h2>ğŸ§  æˆ‘çš„å•è¯æœ¬ï¼ˆäº‘åŒæ­¥ï¼‰</h2>
  <p id="login-status">ç™»å½•ä¸­...</p>

  <div>
    <h3>ğŸ“‚ æˆ‘çš„å•è¯æœ¬åˆ—è¡¨</h3>
    <div id="wordbook-list"></div>
    <button id="createBookBtn">â• æ–°å»ºå•è¯æœ¬</button>
  </div>

  <hr>
  <h3 id="active-book">ğŸ“˜ å½“å‰å•è¯æœ¬ï¼š</h3>
  <input id="word" placeholder="è‹±æ–‡å•è¯">
  <input id="meaning" placeholder="ä¸­æ–‡é‡Šä¹‰">
  <button id="addBtn">æ·»åŠ å•è¯</button>

  <div id="word-list"></div>
</body>
</html>
